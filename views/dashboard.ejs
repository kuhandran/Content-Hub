<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Manager Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      display: flex;
      height: 100vh;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.dark-mode {
      background: #1e1e1e;
      color: #fff;
    }

    .sidebar {
      width: 250px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    .logo {
      font-size: 1.5em;
      margin-bottom: 30px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      text-align: center;
    }

    .menu-section {
      margin-bottom: 25px;
    }

    .menu-title {
      font-size: 0.85em;
      text-transform: uppercase;
      opacity: 0.7;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .menu-item {
      padding: 12px 15px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.2);
      border-left-color: white;
    }

    .menu-item.active {
      background: rgba(255, 255, 255, 0.3);
      border-left-color: white;
      font-weight: 600;
    }

    .submenu {
      margin-left: 20px;
      margin-top: 8px;
      display: none;
    }

    .submenu.open {
      display: block;
    }

    .submenu-item {
      padding: 8px 12px;
      margin-bottom: 5px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .submenu-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .logout-btn {
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .file-list {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .file-item {
      padding: 15px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .file-item:hover {
      background: #f9fafb;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }

    .file-icon {
      font-size: 1.5em;
      min-width: 30px;
    }

    .file-details {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      color: #333;
    }

    .file-meta {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }

    .actions {
      display: flex;
      gap: 5px;
    }

    .action-btn {
      padding: 6px 10px;
      background: #f3f4f6;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
      position: relative;
    }

    .action-btn:hover {
      background: #e5e7eb;
    }

    .menu-toggle {
      display: none;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .upload-toolbar {
      background: white;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .upload-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.2em;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-cancel, .btn-save {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-cancel {
      background: #f3f4f6;
      color: #333;
    }

    .btn-cancel:hover {
      background: #e5e7eb;
    }

    .btn-save {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .empty-state p {
      font-size: 1.1em;
    }

    .search-container {
      background: white;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95em;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .stats-container {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      flex: 1;
      min-width: 150px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stat-icon {
      font-size: 1.8em;
    }

    .stat-content h3 {
      font-size: 0.85em;
      color: #666;
      font-weight: 500;
      margin-bottom: 3px;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: 700;
      color: #333;
    }

    .file-count-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 600;
      margin-left: 8px;
    }

    .search-no-results {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .theme-toggle {
      padding: 8px 12px;
      background: #f3f4f6;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s ease;
      margin-left: 10px;
    }

    .theme-toggle:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }

    body.dark-mode .theme-toggle {
      background: #2d2d2d;
      border-color: #444;
    }

    body.dark-mode .theme-toggle:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    body.dark-mode {
      background: #1e1e1e;
      color: #fff;
    }

    body.dark-mode .header {
      background: #2d2d2d;
      border-bottom-color: #444;
    }

    body.dark-mode .header h1 {
      color: #fff;
    }

    body.dark-mode .user-info {
      color: #fff;
    }

    body.dark-mode .file-list {
      background: #2d2d2d;
      border-color: #444;
    }

    body.dark-mode .file-item {
      border-bottom-color: #444;
    }

    body.dark-mode .file-name {
      color: #fff;
    }

    body.dark-mode .file-meta {
      color: #aaa;
    }

    body.dark-mode .search-container {
      background: #2d2d2d;
      border-bottom-color: #444;
    }

    body.dark-mode .search-input {
      background: #1e1e1e;
      color: #fff;
      border-color: #444;
    }

    body.dark-mode .search-input:focus {
      border-color: #667eea;
    }

    body.dark-mode .upload-toolbar {
      background: #2d2d2d;
      border-bottom-color: #444;
    }

    body.dark-mode .modal-content {
      background: #2d2d2d;
    }

    body.dark-mode .modal-header {
      border-bottom-color: #444;
    }

    body.dark-mode .modal-header h2 {
      color: #fff;
    }

    body.dark-mode .modal-body {
      color: #fff;
    }

    body.dark-mode .modal-footer {
      border-top-color: #444;
    }

    body.dark-mode #jsonEditor {
      background: #1e1e1e !important;
      color: #fff !important;
      border-color: #444 !important;
    }

    body.dark-mode .btn-cancel {
      background: #1e1e1e;
      color: #fff;
      border-color: #444;
    }

    body.dark-mode .btn-cancel:hover {
      background: #444;
    }

    .activity-log {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid #eee;
      max-height: 200px;
      overflow-y: auto;
    }

    body.dark-mode .activity-log {
      background: #2d2d2d;
      border-color: #444;
    }

    .activity-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.85em;
      color: #666;
    }

    body.dark-mode .activity-item {
      border-bottom-color: #444;
      color: #aaa;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-timestamp {
      font-weight: 600;
      color: #333;
    }

    body.dark-mode .activity-timestamp {
      color: #fff;
    }

    /* Tree structure styles */
    .tree-line {
      display: flex;
      align-items: center;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.85em;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .tree-connector {
      color: rgba(255, 255, 255, 0.5);
      font-weight: bold;
      min-width: 20px;
    }

    .tree-node {
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      font-size: 0.9em;
      word-break: break-word;
      flex: 1;
    }

    .tree-node:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .tree-node.file:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .tree-node.file {
      font-size: 0.85em;
      color: rgba(255, 255, 255, 0.85);
      padding: 2px 6px;
    }

    .tree-node.folder {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.95);
    }

    .tree-children {
      display: block;
      margin-left: 0;
    }

    .tree-children.hidden {
      display: none;
    }

    .tree-icon {
      margin-right: 6px;
      display: inline-block;
      min-width: 16px;
    }

    body.dark-mode .tree-node {
      color: rgba(255, 255, 255, 0.8);
    }

    body.dark-mode .tree-node:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .tree-node.folder {
      color: #ffffff;
    }

    body.dark-mode .tree-connector {
      color: rgba(255, 255, 255, 0.4);
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -250px;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
      }

      .sidebar.open {
        left: 0;
      }

      .menu-toggle {
        display: block;
      }

      .stat-card {
        min-width: 120px;
        padding: 12px 15px;
      }

      .stat-icon {
        font-size: 1.4em;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">üìÅ File Manager</div>

    <!-- Collections -->
    <div class="menu-section">
      <div class="menu-title">Data</div>
      <div class="menu-item" onclick="resetCollections()">
        üì¶ Collections
      </div>
      <div class="submenu" id="collectionsMenu">
        <div class="empty-state" style="padding: 10px; font-size: 0.85em;">Loading locales...</div>
      </div>
    </div>

    <!-- Config -->
    <div class="menu-section">
      <div class="menu-title">Settings</div>
      <div class="menu-item" onclick="loadFolder('config')">‚öôÔ∏è Config</div>
    </div>

    <!-- Media -->
    <div class="menu-section">
      <div class="menu-title">Media</div>
      <div class="menu-item" onclick="loadFolder('image')">üñºÔ∏è Image</div>
      <div class="menu-item" onclick="loadFolder('resume')">üìÑ Resume</div>
    </div>

    <!-- Files -->
    <div class="menu-section">
      <div class="menu-title">Storage</div>
      <div class="menu-item" onclick="loadFolder('files')">üìÅ Files</div>
    </div>
  </div>

  <div class="main">
    <div class="header">
      <h1 id="currentPath">üìÅ File Manager</h1>
      <div class="user-info">
        <span>üë§ <%= user.username %></span>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- System Statistics Panel -->
    <div id="systemStatsPanel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; color: white; display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div class="stats-container" style="gap: 20px; margin-bottom: 0; flex: 1;">
          <div class="stat-card" style="background: rgba(255,255,255,0.1); color: white; border: none; box-shadow: none;">
            <div class="stat-icon" style="font-size: 2em;">üìä</div>
            <div class="stat-content">
              <h3 style="color: rgba(255,255,255,0.8);">Total Files</h3>
              <div class="stat-value" id="sysStatTotalFiles" style="color: white;">-</div>
            </div>
          </div>
          <div class="stat-card" style="background: rgba(255,255,255,0.1); color: white; border: none; box-shadow: none;">
            <div class="stat-icon" style="font-size: 2em;">üåç</div>
            <div class="stat-content">
              <h3 style="color: rgba(255,255,255,0.8);">Locales</h3>
              <div class="stat-value" id="sysStatLocales" style="color: white;">-</div>
            </div>
          </div>
          <div class="stat-card" style="background: rgba(255,255,255,0.1); color: white; border: none; box-shadow: none;">
            <div class="stat-icon" style="font-size: 2em;">üíæ</div>
            <div class="stat-content">
              <h3 style="color: rgba(255,255,255,0.8);">Total Size</h3>
              <div class="stat-value" id="sysStatSize" style="color: white; font-size: 1.2em;">-</div>
            </div>
          </div>
          <div class="stat-card" style="background: rgba(255,255,255,0.1); color: white; border: none; box-shadow: none;">
            <div class="stat-icon" style="font-size: 2em;">‚úÖ</div>
            <div class="stat-content">
              <h3 style="color: rgba(255,255,255,0.8);">Complete</h3>
              <div class="stat-value" id="sysStatComplete" style="color: white;">-</div>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-left: 20px;">
          <button onclick="exportBackup()" style="padding: 10px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">üíæ Backup</button>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- Search Section -->
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Search files by name, language, type..." onkeyup="performSearch()">
        <button id="clearSearchBtn" class="upload-btn" style="padding: 8px 12px; display:none;" onclick="clearSearch()">Clear</button>
      </div>

      <!-- Statistics -->
      <div class="stats-container" id="statsContainer" style="display:none;">
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <h3>Total Files</h3>
            <div class="stat-value" id="statTotalFiles">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üåç</div>
          <div class="stat-content">
            <h3>Languages</h3>
            <div class="stat-value" id="statLanguages">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìÅ</div>
          <div class="stat-content">
            <h3>Selected Folder</h3>
            <div class="stat-value" id="statFolder" style="font-size: 1em;">-</div>
          </div>
        </div>
      </div>

      <div class="upload-toolbar">
        <button id="uploadBtn" class="upload-btn" style="display:none;" onclick="triggerUpload()">üì§ Upload File</button>
      </div>

      <div id="fileList" class="file-list">
        <div class="empty-state">
          <p>Select a collection to view files</p>
        </div>
      </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileUploadInput" style="display:none;" onchange="uploadFile()">

    <!-- Edit Modal -->
    <div id="editModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Edit File</h2>
          <button class="modal-close" onclick="closeEditModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <textarea id="jsonEditor" style="width: 100%; height: 400px; padding: 10px; font-family: monospace; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
          <button class="btn-save" onclick="saveEditedFile()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('auth_token');
    let currentEditingFile = null;
    let currentFolder = null; // Track current folder being viewed
    let allFiles = []; // Store all loaded files for search
    let currentLanguage = null;
    let currentType = null;

    if (!token) {
      window.location.href = '/login';
    }

    // Language flags mapping
    const languageFlags = {
      'en': 'üá¨üáß', 'en-US': 'üá∫üá∏', 'en-GB': 'üá¨üáß', 'en-CA': 'üá®üá¶', 'en-AU': 'üá¶üá∫', 'en-NZ': 'üá≥üáø', 'en-MY': 'üá≤üáæ',
      'es': 'üá™üá∏', 'fr': 'üá´üá∑', 'de': 'üá©üá™', 'it': 'üáÆüáπ', 'pt': 'üáµüáπ', 'nl': 'üá≥üá±',
      'ar': 'üá∏üá¶', 'ar-AE': 'üá¶üá™', 'ja': 'üáØüáµ', 'zh': 'üá®üá≥', 'ko': 'üá∞üá∑',
      'hi': 'üáÆüá≥', 'ta': 'üáÆüá≥', 'te': 'üáÆüá≥', 'ka': 'üáÆüá≥',
      'id': 'üáÆüá©', 'my': 'üá≤üáæ', 'th': 'üáπüá≠',
      'si': 'üá±üá∞', 'bn': 'üáßüá©', 'ur': 'üáµüá∞'
    };

    function getLanguageName(code) {
      const names = {
        'en': 'English', 'en-US': 'English (US)', 'en-GB': 'English (GB)', 'en-CA': 'English (CA)',
        'en-AU': 'English (AU)', 'en-NZ': 'English (NZ)', 'en-MY': 'English (MY)',
        'es': 'Espa√±ol', 'fr': 'Fran√ßais', 'de': 'Deutsch', 'it': 'Italiano', 'pt': 'Portugu√™s',
        'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', 'ar-AE': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™)', 'ja': 'Êó•Êú¨Ë™û', 'zh': '‰∏≠Êñá', 'ko': 'ÌïúÍµ≠Ïñ¥',
        'hi': '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', 'ta': '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç', 'te': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å', 'ka': '‡≤ï‡≤®‡≥ç‡≤®‡≤°',
        'id': 'Bahasa Indonesia', 'my': 'Bahasa Melayu', 'th': '‡πÑ‡∏ó‡∏¢',
        'si': '‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω', 'bn': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', 'ur': 'ÿßÿ±ÿØŸà'
      };
      return names[code] || code;
    }

    let allFilesFlat = []; // Flattened file list for global search
    let filesByLocale = {}; // Files organized by locale

    function buildTreeHTML(items, isLast = true, prefix = '') {
      let html = '';
      items.forEach((item, index) => {
        const isLastItem = index === items.length - 1;
        const connector = isLastItem ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
        const nextPrefix = prefix + (isLastItem ? '    ' : '‚îÇ   ');
        
        if (item.type === 'folder') {
          html += `
            <div class="tree-line" style="padding-left: ${prefix.length * 4}px; user-select: none;">
              <span class="tree-connector">${prefix}${connector}</span>
              <span class="tree-node folder" onclick="toggleTreeFolder(event, 'folder-${item.id}')" style="cursor: pointer;">
                <span class="tree-icon">${item.icon}</span>
                <strong>${item.name}</strong>
                ${item.count ? `<span style="font-size: 0.7em; opacity: 0.6;">(${item.count})</span>` : ''}
              </span>
            </div>
            <div class="tree-children visible" id="folder-${item.id}" style="display: block;">
              ${buildTreeHTML(item.children || [], true, nextPrefix)}
            </div>
          `;
        } else {
          html += `
            <div class="tree-line" style="padding-left: ${prefix.length * 4}px;">
              <span class="tree-connector">${prefix}${connector}</span>
              <span class="tree-node file" onclick="loadFileFromPath('${item.path}')" style="cursor: pointer;">
                <span class="tree-icon">${item.icon}</span>
                ${item.name}
              </span>
            </div>
          `;
        }
      });
      return html;
    }

    async function loadCollectionsMenu() {
      console.log('=== loadCollectionsMenu STARTED ===');
      
      const menu = document.getElementById('collectionsMenu');
      console.log('Menu element found:', !!menu);
      
      if (!menu) {
        console.error('collectionsMenu element not found');
        return;
      }

      try {
        console.log('üì° Fetching scanner files from /api/scanner/files...');
        console.log('Global token available:', !!token);
        console.log('Token value:', token ? token.substring(0, 20) + '...' : 'NO TOKEN');
        
        const res = await fetch('/api/scanner/files', {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('üìä Scanner response status:', res.status);
        console.log('Response headers:', res.headers);

        if (!res.ok) {
          const errorText = await res.text();
          console.error('API Error Response:', errorText);
          throw new Error(`Failed to load files: ${res.status} - ${errorText}`);
        }
        
        const data = await res.json();
        console.log('‚úÖ API Response received:', data);
        
        filesByLocale = data.grouped || {};
        allFilesFlat = data.files || [];
        
        console.log('üì¶ filesByLocale:', filesByLocale);
        console.log('üì¶ allFilesFlat count:', allFilesFlat.length);
        
        if (!filesByLocale || Object.keys(filesByLocale).length === 0) {
          console.log('‚ö†Ô∏è No files found in response');
          menu.innerHTML = '<div class="submenu-item">No files found</div>';
          return;
        }

        console.log('üåç Building tree with locales:', Object.keys(filesByLocale));

        // Build simple tree structure
        let treeHTML = '<div style="font-family: monospace; font-size: 0.8em; line-height: 1.8; padding: 5px;">';
        let fileCount = 0;
        
        Object.keys(filesByLocale).sort().forEach((locale, idx) => {
          const localeFiles = filesByLocale[locale] || [];
          const categories = [...new Set(localeFiles.map(f => f.category))].sort();
          const isLastLocale = idx === Object.keys(filesByLocale).length - 1;
          
          console.log(`  üìç Locale: ${locale}, files: ${localeFiles.length}, categories: ${categories.join(', ')}`);
          
          treeHTML += `<div style="margin: 3px 0;">
            ${isLastLocale ? '‚îî‚îÄ ' : '‚îú‚îÄ '}<strong>${languageFlags[locale] || 'üìÅ'} ${locale}</strong> (${localeFiles.length})<br>`;
          
          categories.forEach((cat, catIdx) => {
            const catFiles = localeFiles.filter(f => f.category === cat);
            const isLastCat = catIdx === categories.length - 1;
            
            console.log(`    üìÇ Category: ${cat}, files: ${catFiles.length}`);
            
            treeHTML += `<div style="margin-left: 16px; margin: 2px 0 2px 16px;">
              ${isLastLocale ? '  ' : '‚îÇ '}${isLastCat ? '‚îî‚îÄ ' : '‚îú‚îÄ '}<strong>${cat === 'config' ? '‚öôÔ∏è' : 'üìÇ'} ${cat}</strong> (${catFiles.length})<br>`;
            
            catFiles.forEach((file, fileIdx) => {
              const isLastFile = fileIdx === catFiles.length - 1;
              fileCount++;
              treeHTML += `<div style="margin-left: 32px; margin: 1px 0 1px 32px; cursor: pointer;" onclick="loadFileFromPath('${file.path}')">
                ${isLastLocale ? '  ' : '‚îÇ '}${isLastCat ? '  ' : '‚îÇ '}${isLastFile ? '‚îî‚îÄ ' : '‚îú‚îÄ '}üìÑ ${file.name}
              </div>`;
            });
            
            treeHTML += '</div>';
          });
          
          treeHTML += '</div>';
        });
        
        treeHTML += '</div>';
        
        console.log('üé® Tree HTML generated:');
        console.log('  - Total files rendered:', fileCount);
        console.log('  - HTML length:', treeHTML.length);
        
        menu.innerHTML = treeHTML;
        console.log('‚úÖ Tree rendered to #collectionsMenu');
        console.log('=== loadCollectionsMenu COMPLETED ===');
      } catch (error) {
        console.error('‚ùå ERROR in loadCollectionsMenu:', error);
        console.error('Stack:', error.stack);
        menu.innerHTML = `
          <div class="submenu-item" style="color: red; cursor: default; padding: 10px; word-break: break-word;">
            Error: ${error.message}
          </div>
        `;
      }
    }

    function toggleTreeFolder(event, folderId) {
      event.stopPropagation();
      const folder = document.getElementById(folderId);
      
      if (folder) {
        const isVisible = folder.style.display !== 'none';
        folder.style.display = isVisible ? 'none' : 'block';
      }
    }

    async function loadFileFromPath(filePath) {
      try {
        const parts = filePath.split('/');
        const language = parts[0];
        const category = parts[1];
        const filename = parts.slice(2).join('/');
        
        currentLanguage = language;
        currentType = category;
        
        document.getElementById('currentPath').textContent = `üìÅ ${language} / ${category} / ${filename}`;
        
        // Load and display the file (without hiding the tree)
        viewCollectionFile(language, category, filename);
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function resetCollections() {
      // Reset file list to empty state
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '<div class="empty-state"><p>Select a collection to view files</p></div>';
      
      // Hide upload button
      document.getElementById('uploadBtn').style.display = 'none';
      
      // Reset current folder
      currentFolder = null;
      
      // Reset document title
      document.getElementById('currentPath').textContent = 'üìÅ Collections';
    }

    // Legacy function - kept for compatibility
    function expandLocale(code, event) {
      event.stopPropagation();
      toggleLocaleMenu(code, event);
    }

    // Legacy function - kept for compatibility
    async function loadCollectionFolder(language, type) {
      try {
        const res = await fetch(`/api/collections/${language}/${type}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Failed to load ${type} folder`);

        const data = await res.json();
        displayCollectionFiles(data.files || [], language, type);
        document.getElementById('currentPath').textContent = `üìÅ ${language} / ${type}`;
        
        // Set current folder and show appropriate upload button
        currentFolder = { language, type, category: 'collection' };
        updateUploadButton();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function updateUploadButton() {
      const uploadBtn = document.getElementById('uploadBtn');
      
      if (!currentFolder) {
        uploadBtn.style.display = 'none';
        return;
      }

      uploadBtn.style.display = 'block';

      if (currentFolder.category === 'collection') {
        uploadBtn.textContent = `üì§ Upload to ${currentFolder.language} / ${currentFolder.type}`;
      } else if (currentFolder.category === 'config') {
        uploadBtn.textContent = 'üì§ Upload Config';
      } else if (currentFolder.category === 'image') {
        uploadBtn.textContent = 'üì§ Upload Image';
      } else if (currentFolder.category === 'resume') {
        uploadBtn.textContent = 'üì§ Upload Resume';
      } else if (currentFolder.category === 'files') {
        uploadBtn.textContent = 'üì§ Upload File';
      }
    }

    // Handle 401 Unauthorized responses
    function handleUnauthorized(response) {
      if (response.status === 401) {
        console.log('[AUTH] Session expired or unauthorized - redirecting to login');
        localStorage.removeItem('auth_token');
        window.location.href = '/login';
        return true;
      }
      return false;
    }

    function toggleSubmenu(el) {
      const submenu = el.nextElementSibling;
      if (submenu && submenu.classList.contains('submenu')) {
        submenu.classList.toggle('open');
        el.classList.toggle('active');
      }
    }

    function displayCollectionFiles(files, language, type) {
      const fileList = document.getElementById('fileList');

      // Store files for search functionality
      allFiles = files;
      currentLanguage = language;
      currentType = type;
      
      // Update statistics
      updateStatsDisplay();

      if (!files || files.length === 0) {
        fileList.innerHTML = '<div class="empty-state"><p>No files in this folder</p></div>';
        return;
      }

      fileList.innerHTML = files.map(file => `
        <div class="file-item">
          <div class="file-info">
            <div class="file-icon">üìÑ</div>
            <div class="file-details">
              <div class="file-name">${file.name}</div>
              <div class="file-meta">${(file.size / 1024).toFixed(2)} KB</div>
            </div>
          </div>
          <div class="file-actions">
            <button class="action-btn" title="Copy Path" onclick="copyFilePath('${language}', '${type}', '${file.name}')">üìã</button>
            <button class="action-btn edit-btn" title="View" onclick="viewCollectionFile('${language}', '${type}', '${file.name}')">üëÅÔ∏è</button>
            <button class="action-btn edit-btn" title="Edit" onclick="editCollectionFileModal('${language}', '${type}', '${file.name}')">‚úèÔ∏è</button>
            <button class="action-btn delete-btn" title="Delete" onclick="deleteCollectionFile('${language}', '${type}', '${file.name}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function copyFilePath(language, type, fileName) {
      const path = `/collections/${language}/${type}/${fileName}`;
      navigator.clipboard.writeText(path).then(() => {
        alert(`‚úì Path copied: ${path}`);
      });
    }

    async function viewCollectionFile(language, type, file) {
      try {
        const res = await fetch(`/api/collections/${language}/${type}/${file}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to load file');

        const data = await res.json();
        const content = JSON.stringify(data, null, 2);
        
        document.getElementById('modalTitle').textContent = `View: ${language} / ${type} / ${file}`;
        document.getElementById('jsonEditor').value = content;
        document.getElementById('jsonEditor').readOnly = true;
        document.getElementById('editModal').style.display = 'flex';
        
        currentEditingFile = null;
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function editCollectionFileModal(language, type, file) {
      try {
        const res = await fetch(`/api/collections/${language}/${type}/${file}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to load file');

        const data = await res.json();
        const content = JSON.stringify(data, null, 2);
        
        document.getElementById('modalTitle').textContent = `Edit: ${language} / ${type} / ${file}`;
        document.getElementById('jsonEditor').value = content;
        document.getElementById('editModal').style.display = 'flex';
        
        // Store current editing file info
        currentEditingFile = { language, type, file };
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('jsonEditor').value = '';
      document.getElementById('jsonEditor').readOnly = false;
      currentEditingFile = null;
    }

    async function saveEditedFile() {
      if (!currentEditingFile) {
        alert('Read-only mode. Click Edit button to make changes.');
        return;
      }

      const content = document.getElementById('jsonEditor').value;
      const { language, type, file } = currentEditingFile;

      try {
        const data = JSON.parse(content);
        const res = await fetch(`/api/collections/${language}/${type}/${file}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!res.ok) throw new Error('Failed to save file');

        logActivity('save', file, language, type);
        closeEditModal();
        loadCollectionFolder(language, type);
        alert('‚úì File saved successfully!');
      } catch (error) {
        alert('Error saving file: ' + error.message);
      }
    }

    async function deleteCollectionFile(language, type, file) {
      if (!confirm(`Delete ${file}?`)) return;

      try {
        const res = await fetch(`/api/collections/${language}/${type}/${file}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to delete file');

        logActivity('delete', file, language, type);
        loadCollectionFolder(language, type);
        alert('File deleted successfully');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function triggerUpload() {
      if (!currentFolder) {
        alert('Please select a folder first');
        return;
      }

      // Ask for filename
      let filename = prompt('Enter JSON filename (without .json extension):', 'newfile');
      
      if (!filename) return;
      
      // Clean filename and add .json if needed
      filename = filename.trim().replace(/\.json$/i, '') + '.json';
      
      // Validate filename
      if (!/^[a-zA-Z0-9_-]+\.json$/.test(filename)) {
        alert('Invalid filename. Use only letters, numbers, hyphens, and underscores.');
        return;
      }

      // Store filename and trigger file input
      window.pendingFilename = filename;
      document.getElementById('fileUploadInput').click();
    }

    async function uploadFile() {
      const fileInput = document.getElementById('fileUploadInput');
      const file = fileInput.files[0];

      if (!file || !currentFolder) {
        alert('Please select a folder first');
        fileInput.value = '';
        return;
      }

      try {
        const formData = new FormData();
        
        // Use pending filename if set, otherwise use uploaded file's name
        const uploadName = window.pendingFilename || file.name;
        window.pendingFilename = null;
        
        const fileContent = await file.text();
        
        // Validate JSON
        let jsonData;
        try {
          jsonData = JSON.parse(fileContent);
        } catch (e) {
          alert('Invalid JSON file. Please check the file content.');
          fileInput.value = '';
          return;
        }

        // Create blob with proper filename
        const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
        const renamedFile = new File([blob], uploadName, { type: 'application/json' });
        
        formData.append('file', renamedFile);

        let uploadUrl = '';

        if (currentFolder.category === 'collection') {
          uploadUrl = `/api/collections/upload/${currentFolder.language}/${currentFolder.type}`;
        } else if (currentFolder.category === 'config') {
          uploadUrl = `/api/files/upload/config`;
        } else if (currentFolder.category === 'image') {
          uploadUrl = `/api/files/upload/image`;
        } else if (currentFolder.category === 'resume') {
          uploadUrl = `/api/files/upload/resume`;
        } else if (currentFolder.category === 'files') {
          uploadUrl = `/api/files/upload/files`;
        }

        const res = await fetch(uploadUrl, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        if (!res.ok) throw new Error('Upload failed');

        alert(`‚úì File uploaded successfully: ${uploadName}`);

        // Refresh current view
        if (currentFolder.category === 'collection') {
          loadCollectionFolder(currentFolder.language, currentFolder.type);
        }

        // Reset file input
        fileInput.value = '';
      } catch (error) {
        alert('Upload error: ' + error.message);
      }
    }

    async function loadFolder(folderPath) {
      try {
        const res = await fetch(`/api/files/list/${folderPath}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (handleUnauthorized(res)) return;
        if (!res.ok) throw new Error('Failed to load folder');

        const data = await res.json();
        displayFiles(data.items, folderPath);
        document.getElementById('currentPath').textContent = `üìÅ ${folderPath}`;
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function displayFiles(items, folderPath) {
      const fileList = document.getElementById('fileList');

      if (!items || items.length === 0) {
        fileList.innerHTML = '<div class="empty-state"><p>No files in this folder</p></div>';
        return;
      }

      fileList.innerHTML = items.map(item => `
        <div class="file-item">
          <div class="file-info">
            <div class="file-icon">${getFileIcon(item)}</div>
            <div class="file-details">
              <div class="file-name">${item.name}</div>
              <div class="file-meta">
                ${item.isDirectory ? 'Folder' : `${(item.size / 1024).toFixed(2)} KB`}
                ‚Ä¢ ${new Date(item.modified).toLocaleDateString()}
              </div>
            </div>
          </div>
          <div class="actions">
            <button class="action-btn" onclick="copyPath('${item.path}')" title="Copy Path">üìã</button>
            ${!item.isDirectory ? `
              <button class="action-btn" onclick="editFile('${item.path}')" title="Edit">‚úèÔ∏è</button>
              <button class="action-btn" onclick="deleteFile('${item.path}')" title="Delete">üóëÔ∏è</button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    function getFileIcon(item) {
      if (item.isDirectory) return 'üìÇ';
      const ext = item.ext.toLowerCase();
      if (['.json'].includes(ext)) return 'üìÑ';
      if (['.png', '.jpg', '.jpeg', '.webp', '.gif'].includes(ext)) return 'üñºÔ∏è';
      if (['.pdf', '.doc', '.docx'].includes(ext)) return 'üìÉ';
      return 'üì¶';
    }

    function copyPath(path) {
      const fullPath = `/public/${path}`;
      navigator.clipboard.writeText(fullPath).then(() => {
        alert('Path copied: ' + fullPath);
      });
    }

    function editFile(path) {
      alert('Edit feature coming soon for: ' + path);
    }

    async function deleteFile(path) {
      if (!confirm('Delete ' + path + '?')) return;

      try {
        const res = await fetch(`/api/files/delete/${path}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (handleUnauthorized(res)) return;
        if (!res.ok) throw new Error('Failed to delete');

        alert('File deleted');
        location.reload();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function logout() {
      fetch('/api/auth/logout', { method: 'POST' })
        .catch(() => {}) // Ignore errors
        .finally(() => {
          localStorage.removeItem('auth_token');
          window.location.href = '/login';
        });
    }

    // ===== SEARCH & FILTER FUNCTIONALITY =====
    function performSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const fileList = document.getElementById('fileList');
      const treeContainer = document.getElementById('collectionsMenu');
      
      if (!query) {
        // Show tree again
        treeContainer.style.display = 'block';
        fileList.innerHTML = '<div class="empty-state"><p>Select a file from the sidebar or use search</p></div>';
        document.getElementById('clearSearchBtn').style.display = 'none';
        return;
      }

      // Hide tree when searching
      treeContainer.style.display = 'none';
      document.getElementById('clearSearchBtn').style.display = 'block';

      // Search across all files
      const filtered = allFilesFlat.filter(file => {
        const name = file.name.toLowerCase();
        const path = file.path.toLowerCase();
        const locale = file.locale.toLowerCase();
        const category = file.category.toLowerCase();
        
        return name.includes(query) || 
               path.includes(query) || 
               locale.includes(query) || 
               category.includes(query);
      });

      if (filtered.length === 0) {
        fileList.innerHTML = `<div class="empty-state"><p>‚ùå No files found matching "${query}"</p><p style="font-size: 0.9em; margin-top: 10px;">Try searching by filename, locale, or category</p></div>`;
        return;
      }

      // Display filtered results
      fileList.innerHTML = `
        <div style="padding: 15px; background: #f0f4ff; border-bottom: 1px solid #e0e7ff;">
          <strong>üîç Search Results: ${filtered.length} files found</strong>
        </div>
        ${filtered.map((file, index) => `
          <div class="file-item">
            <div class="file-info">
              <div class="file-icon">üìÑ</div>
              <div class="file-details">
                <div class="file-name">${file.name}</div>
                <div class="file-meta">
                  ${languageFlags[file.locale] || 'üìÇ'} ${getLanguageName(file.locale)} ‚Ä¢ ${file.category} ‚Ä¢ <span style="font-size: 0.85em; opacity: 0.7;">${file.path}</span>
                  <span class="file-count-badge">${(file.size || 0).toLocaleString()} B</span>
                </div>
              </div>
            </div>
            <div class="actions">
              <button class="action-btn" title="Copy Path" onclick="copyFilePath('${file.locale}', '${file.category}', '${file.name}')">üìã</button>
              <button class="action-btn" title="View" onclick="viewCollectionFile('${file.locale}', '${file.category}', '${file.name}')">üëÅÔ∏è</button>
              <button class="action-btn" title="Edit" onclick="editCollectionFileModal('${file.locale}', '${file.category}', '${file.name}')">‚úèÔ∏è</button>
              <button class="action-btn" title="Delete" onclick="deleteCollectionFile('${file.locale}', '${file.category}', '${file.name}')">üóëÔ∏è</button>
            </div>
          </div>
        `).join('')}
      `;
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('clearSearchBtn').style.display = 'none';
      // Show tree again
      document.getElementById('collectionsMenu').style.display = 'block';
      document.getElementById('fileList').innerHTML = '<div class="empty-state"><p>Select a file from the sidebar or use search</p></div>';
    }

    function updateStatsDisplay() {
      const statsContainer = document.getElementById('statsContainer');
      if (currentFolder) {
        statsContainer.style.display = 'flex';
        document.getElementById('statTotalFiles').textContent = allFiles.length;
        document.getElementById('statLanguages').textContent = currentLanguage ? '1' : '0';
        document.getElementById('statFolder').textContent = `${currentLanguage}/${currentType}`;
      } else {
        statsContainer.style.display = 'none';
      }
    }

    // ===== SYSTEM STATISTICS FUNCTIONALITY =====
    async function loadSystemStatistics() {
      try {
        const res = await fetch('/api/config/statistics', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to load statistics');

        const data = await res.json();
        const stats = data.data;

        // Update system stats display
        document.getElementById('sysStatTotalFiles').textContent = stats.totalFiles;
        document.getElementById('sysStatLocales').textContent = `${stats.completedLocales}/${stats.totalLocales}`;
        document.getElementById('sysStatSize').textContent = `${stats.totalSizeKB} KB`;
        document.getElementById('sysStatComplete').textContent = `${stats.systemHealth.completeness}`;
        
        // Show stats panel
        document.getElementById('systemStatsPanel').style.display = 'block';
      } catch (error) {
        console.warn('Could not load system statistics:', error.message);
      }
    }

    // ===== BACKUP & EXPORT FUNCTIONALITY =====
    async function exportBackup() {
      try {
        const response = await fetch('/api/backup/export', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to export backup');

        // Get filename from Content-Disposition header
        const disposition = response.headers.get('content-disposition');
        let filename = 'collections-backup.zip';
        if (disposition && disposition.includes('filename=')) {
          filename = disposition.split('filename=')[1].replace(/"/g, '');
        }

        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        alert(`‚úì Backup downloaded: ${filename}`);
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    async function exportLocaleBackup(locale) {
      try {
        const response = await fetch(`/api/backup/export/${locale}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to export backup');

        const disposition = response.headers.get('content-disposition');
        let filename = `${locale}-backup.zip`;
        if (disposition && disposition.includes('filename=')) {
          filename = disposition.split('filename=')[1].replace(/"/g, '');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        alert(`‚úì ${locale} backup downloaded: ${filename}`);
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // ===== DARK MODE FUNCTIONALITY =====
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
      updateThemeIcon();
    }

    function updateThemeIcon() {
      const btn = document.querySelector('.theme-toggle');
      const isDark = document.body.classList.contains('dark-mode');
      btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    function loadTheme() {
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
      }
      updateThemeIcon();
    }

    // ===== ACTIVITY LOG FUNCTIONALITY =====
    let activityLog = [];
    
    function logActivity(action, filename, language, type) {
      const timestamp = new Date().toLocaleTimeString();
      activityLog.unshift({
        action,
        filename,
        language,
        type,
        timestamp
      });
      
      // Keep last 20 activities
      if (activityLog.length > 20) {
        activityLog.pop();
      }
      
      displayActivityLog();
    }

    function displayActivityLog() {
      const existingLog = document.getElementById('activityLog');
      if (!existingLog) return;

      existingLog.innerHTML = activityLog.map(item => `
        <div class="activity-item">
          <span class="activity-timestamp">${item.timestamp}</span> - 
          <strong>${item.action}</strong> ${item.filename} 
          (${item.language}/${item.type})
        </div>
      `).join('');
    }

    // ===== FILE TEMPLATES FUNCTIONALITY =====
    const fileTemplates = {
      'projects': {
        projects: [],
        lastUpdated: new Date().toISOString()
      },
      'experience': {
        experience: [],
        lastUpdated: new Date().toISOString()
      },
      'skills': {
        skills: {},
        lastUpdated: new Date().toISOString()
      },
      'education': {
        education: [],
        lastUpdated: new Date().toISOString()
      },
      'achievements': {
        achievements: [],
        lastUpdated: new Date().toISOString()
      },
      'chatConfig': {
        botName: 'Assistant',
        language: 'en',
        responseDelay: 1000
      },
      'contentLabels': {
        nav: {},
        sections: {},
        buttons: {}
      }
    };

    // ===== BULK OPERATIONS FUNCTIONALITY =====
    let selectedFiles = new Set();

    function toggleFileSelection(language, type, filename) {
      const key = `${language}/${type}/${filename}`;
      if (selectedFiles.has(key)) {
        selectedFiles.delete(key);
      } else {
        selectedFiles.add(key);
      }
      updateBulkOperationsUI();
    }

    function updateBulkOperationsUI() {
      const bulkPanel = document.getElementById('bulkOperationsPanel');
      if (!bulkPanel) {
        createBulkOperationsPanel();
      }
      
      if (selectedFiles.size > 0) {
        document.getElementById('bulkOperationsPanel').style.display = 'flex';
        document.getElementById('bulkCount').textContent = selectedFiles.size;
      } else {
        document.getElementById('bulkOperationsPanel').style.display = 'none';
      }
    }

    function createBulkOperationsPanel() {
      const toolbar = document.querySelector('.upload-toolbar');
      const panel = document.createElement('div');
      panel.id = 'bulkOperationsPanel';
      panel.style.cssText = 'background: #fff3cd; padding: 12px 20px; border-bottom: 1px solid #ffc107; display: none; gap: 10px; align-items: center; margin-bottom: 15px;';
      panel.innerHTML = `
        <span style="font-weight: 600;">üìã <span id="bulkCount">0</span> files selected</span>
        <button class="upload-btn" style="background: #ffc107; color: #333; flex: 0; padding: 6px 12px; font-size: 0.85em;" onclick="bulkDeleteFiles()">üóëÔ∏è Delete Selected</button>
        <button class="upload-btn" style="background: #28a745; flex: 0; padding: 6px 12px; font-size: 0.85em;" onclick="bulkBackupFiles()">üíæ Backup Selected</button>
        <button class="upload-btn" style="background: #6c757d; flex: 0; padding: 6px 12px; font-size: 0.85em;" onclick="clearSelection()">‚úï Clear</button>
      `;
      toolbar.parentNode.insertBefore(panel, toolbar);
    }

    function clearSelection() {
      selectedFiles.clear();
      updateBulkOperationsUI();
    }

    async function bulkDeleteFiles() {
      if (selectedFiles.size === 0) return;
      if (!confirm(`Delete ${selectedFiles.size} files?`)) return;

      let deleted = 0;
      for (const key of selectedFiles) {
        const [language, type, filename] = key.split('/');
        try {
          await deleteCollectionFile(language, type, filename);
          deleted++;
        } catch (err) {
          console.error(`Failed to delete ${key}:`, err);
        }
      }

      logActivity('bulk-delete', `${deleted} files`, currentLanguage || 'all', currentType || 'all');
      selectedFiles.clear();
      updateBulkOperationsUI();
      alert(`‚úì Deleted ${deleted} files`);
    }

    async function bulkBackupFiles() {
      if (selectedFiles.size === 0) return;
      alert(`üíæ Backup feature for selected files coming soon! (${selectedFiles.size} files)`);
    }

    // Load collections menu and system statistics on page load
    console.log('üöÄ Initializing dashboard...');
    loadTheme();
    console.log('‚úÖ Theme loaded');
    loadCollectionsMenu();
    console.log('‚úÖ Collections menu called');
    loadSystemStatistics();
    console.log('‚úÖ Statistics loaded');
    createBulkOperationsPanel();
    console.log('‚úÖ Dashboard initialization complete');
  </script>

</body>
</html>
