{"version":3,"sources":["../../../lib/sync-config.js","../../../lib/dbop.js"],"sourcesContent":["const path = require('path');\n\nconst ALLOWED_EXTENSIONS = [\n  '.json', '.js', '.xml', '.html', '.txt', '.pdf',\n  '.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp', '.docx'\n];\n\nconst IGNORED_DIRS = ['.next', 'node_modules', '.git'];\n\nfunction getPublicDir() {\n  const override = process.env.PUBLIC_DIR;\n  return override && override.trim() ? path.resolve(override) : path.join(process.cwd(), 'public');\n}\n\nfunction getFileExtension(filename) {\n  return path.extname(filename).toLowerCase().slice(1) || 'unknown';\n}\n\nfunction mapFileToTable(filePath) {\n  if (filePath.includes(`${path.sep}collections${path.sep}`)) {\n    return { table: 'collections', fileType: 'json' };\n  }\n  if (filePath.includes(`${path.sep}files${path.sep}`)) {\n    const ext = getFileExtension(filePath);\n    return { table: 'static_files', fileType: ext };\n  }\n  if (filePath.includes(`${path.sep}config${path.sep}`)) {\n    const ext = getFileExtension(filePath);\n    return { table: 'config_files', fileType: ext };\n  }\n  if (filePath.includes(`${path.sep}data${path.sep}`)) {\n    const ext = getFileExtension(filePath);\n    return { table: 'data_files', fileType: ext };\n  }\n  if (filePath.includes(`${path.sep}image${path.sep}`)) {\n    return { table: 'images', fileType: getFileExtension(filePath) };\n  }\n  if (filePath.includes(`${path.sep}js${path.sep}`)) {\n    return { table: 'javascript_files', fileType: 'js' };\n  }\n  if (filePath.includes(`${path.sep}resume${path.sep}`)) {\n    return { table: 'resumes', fileType: getFileExtension(filePath) };\n  }\n  return { table: 'unknown', fileType: getFileExtension(filePath) };\n}\n\nmodule.exports = {\n  ALLOWED_EXTENSIONS,\n  IGNORED_DIRS,\n  getPublicDir,\n  getFileExtension,\n  mapFileToTable,\n};\n","// Unified DB operations using DATABASE_URL (postgres) with Supabase fallback\nconst postgres = require('postgres');\nconst { createClient } = require('@supabase/supabase-js');\n\nconst TABLES = ['collections','static_files','config_files','data_files','images','resumes','javascript_files','sync_manifest'];\n\nfunction getSqlClient() {\n  const url = process.env.DATABASE_URL;\n  if (!url) return null;\n  try {\n    const sql = postgres(url, { max: 5, prepare: true, ssl: 'prefer' });\n    return sql;\n  } catch (err) {\n    console.error('[DBOP] Postgres init error:', err.message);\n    return null;\n  }\n}\n\nfunction getSupabaseClient() {\n  const url = process.env.SUPABASE_URL || '';\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY || '';\n  if (!url || !key) return null;\n  try {\n    return createClient(url, key);\n  } catch (err) {\n    console.error('[DBOP] Supabase init error:', err.message);\n    return null;\n  }\n}\n\nfunction db() {\n  const sql = getSqlClient();\n  const supabase = sql ? null : getSupabaseClient();\n  const mode = sql ? 'postgres' : (supabase ? 'supabase' : 'none');\n  if (mode === 'none') {\n    throw new Error('No database configured: set DATABASE_URL or SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY');\n  }\n  return { mode, sql, supabase };\n}\n\nasync function createdb() {\n  const { mode, sql, supabase } = db();\n  const statements = [\n    `CREATE TABLE IF NOT EXISTS collections (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), lang VARCHAR(10), type VARCHAR(20), filename VARCHAR(255), file_content JSONB, file_hash VARCHAR(64), synced_at TIMESTAMP DEFAULT now(), created_at TIMESTAMP DEFAULT now(), updated_at TIMESTAMP DEFAULT now(), UNIQUE(lang, type, filename))`,\n    `CREATE TABLE IF NOT EXISTS static_files (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), filename VARCHAR(255) UNIQUE, file_type VARCHAR(50), file_content TEXT, file_hash VARCHAR(64), synced_at TIMESTAMP DEFAULT now(), created_at TIMESTAMP DEFAULT now(), updated_at TIMESTAMP DEFAULT now())`,\n    `CREATE TABLE IF NOT EXISTS config_files (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), filename VARCHAR(255) UNIQUE, file_type VARCHAR(50), file_content JSONB, file_hash VARCHAR(64), synced_at TIMESTAMP DEFAULT now(), created_at TIMESTAMP DEFAULT now(), updated_at TIMESTAMP DEFAULT now())`,\n    `CREATE TABLE IF NOT EXISTS data_files (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), filename VARCHAR(255) UNIQUE, file_type VARCHAR(50), file_content JSONB, file_hash VARCHAR(64), synced_at TIMESTAMP DEFAULT now(), created_at TIMESTAMP DEFAULT now(), updated_at TIMESTAMP DEFAULT now())`,\n    `CREATE TABLE IF NOT EXISTS images (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), filename VARCHAR(255) UNIQUE, file_path VARCHAR(512), mime_type VARCHAR(50), file_hash VARCHAR(64), synced_at TIMESTAMP DEFAULT now(), created_at TIMESTAMP DEFAULT now(), updated_at TIMESTAMP DEFAULT now())`,\n    `CREATE TABLE IF NOT EXISTS resumes (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), filename VARCHAR(255) UNIQUE, file_type VARCHAR(50), file_path VARCHAR(512), file_hash VARCHAR(64), synced_at TIMESTAMP DEFAULT now(), created_at TIMESTAMP DEFAULT now(), updated_at TIMESTAMP DEFAULT now())`,\n    `CREATE TABLE IF NOT EXISTS javascript_files (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), filename VARCHAR(255) UNIQUE, file_path VARCHAR(512), file_content TEXT, file_hash VARCHAR(64), synced_at TIMESTAMP DEFAULT now(), created_at TIMESTAMP DEFAULT now(), updated_at TIMESTAMP DEFAULT now())`,\n    `CREATE TABLE IF NOT EXISTS sync_manifest (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), file_path VARCHAR(512) UNIQUE, file_hash VARCHAR(64), table_name VARCHAR(50), last_synced TIMESTAMP DEFAULT now())`,\n    `CREATE INDEX IF NOT EXISTS idx_collections_lang ON collections(lang)`,\n    `CREATE INDEX IF NOT EXISTS idx_sync_manifest_path ON sync_manifest(file_path)`\n  ];\n  if (mode === 'postgres') {\n    let created = 0;\n    for (const stmt of statements) {\n      try { await sql.unsafe(stmt); created++; } catch (err) { console.warn('[DBOP] createDB warn:', err.message); }\n    }\n    return { status: 'success', operation: 'createdb', statements_executed: created };\n  } else {\n    let created = 0;\n    for (const stmt of statements) {\n      try { await supabase.rpc('exec_sql', { sql: stmt }); created++; } catch (err) { if (!String(err.message).includes('exists')) console.warn('[DBOP] createDB warn:', err.message); }\n    }\n    return { status: 'success', operation: 'createdb', statements_executed: created };\n  }\n}\n\nasync function deletedb() {\n  const { mode, sql, supabase } = db();\n  let cleared = 0;\n  if (mode === 'postgres') {\n    for (const table of TABLES) {\n      try { await sql.unsafe(`DELETE FROM ${table}`); cleared++; } catch (err) { console.warn('[DBOP] delete warn:', table, err.message); }\n    }\n  } else {\n    for (const table of TABLES) {\n      try { await supabase.from(table).delete().neq('id', null); cleared++; } catch (err) { console.warn('[DBOP] delete warn:', table, err.message); }\n    }\n  }\n  return { status: 'success', operation: 'deletedb', tables_cleared: cleared };\n}\n\nasync function count(table) {\n  const { mode, sql, supabase } = db();\n  if (mode === 'postgres') {\n    try { const rows = await sql`SELECT COUNT(*)::int AS count FROM ${sql(table)}`; return rows?.[0]?.count || 0; } catch { return 0; }\n  } else {\n    try { const { count } = await supabase.from(table).select('*', { count: 'exact', head: true }); return count || 0; } catch { return 0; }\n  }\n}\n\nasync function getManifest() {\n  const { mode, sql, supabase } = db();\n  if (mode === 'postgres') {\n    try { return await sql`SELECT file_path, file_hash, table_name FROM sync_manifest`; } catch { return []; }\n  } else {\n    const { data, error } = await supabase.from('sync_manifest').select('*');\n    if (error) return [];\n    return data || [];\n  }\n}\n\nasync function upsertManifest(entry) {\n  const { mode, sql, supabase } = db();\n  if (mode === 'postgres') {\n    try {\n      await sql`\n        INSERT INTO sync_manifest (file_path, file_hash, table_name, last_synced)\n        VALUES (${entry.file_path}, ${entry.file_hash}, ${entry.table_name}, ${entry.last_synced})\n        ON CONFLICT (file_path) DO UPDATE SET file_hash = EXCLUDED.file_hash, table_name = EXCLUDED.table_name, last_synced = EXCLUDED.last_synced\n      `;\n      return true;\n    } catch { return false; }\n  } else {\n    try {\n      await supabase.from('sync_manifest').upsert(entry, { onConflict: 'file_path' });\n      return true;\n    } catch { return false; }\n  }\n}\n\nmodule.exports = { db, createdb, deletedb, count, getManifest, upsertManifest, TABLES };\n"],"names":[],"mappings":"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"}